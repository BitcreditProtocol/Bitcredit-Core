<project>
    <shortName>bitcreditcore</shortName>
    <fullName>Bitcredit Core</fullName>
    <version>0.0</version>
    <splashImage>${build_project_directory}/images/bitcredit_logo.png</splashImage>
    <windowsExecutableIcon>${build_project_directory}/windows/bitcredit.ico</windowsExecutableIcon>
    <windowsUninstallerExecutableIcon>${build_project_directory}/windows/bitcredit.ico</windowsUninstallerExecutableIcon>
    <osxApplicationBundleIcon>${build_project_directory}/macos/bitcredit.icns</osxApplicationBundleIcon>
    <!-- <osxUninstallerApplicationBundleIcon>${build_project_directory}/macos/bitcredit.icns</osxUninstallerApplicationBundleIcon> -->
    <logoImage>${build_project_directory}/images/bitcredit_logo.png</logoImage>
    <createOsxBundleDmg>1</createOsxBundleDmg>
    <initializationActionList>
        <setInstallerVariable>
            <name>skip_vc_install</name>
            <value>1</value>
            <ruleList>
                <platformTest>
                    <type>windows-x64</type>
                </platformTest>
                <registryTest>
                    <key>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\VisualStudio\14.0\VC\Runtimes\X64\</key>
                    <logic>exists</logic>
                    <name>Version</name>
                </registryTest>
            </ruleList>
        </setInstallerVariable>
        <setInstallerVariable>
            <name>skip_openssl_install</name>
            <value>1</value>
            <ruleList>
                <platformTest>
                    <type>windows-x64</type>
                </platformTest>
                <registryTest>
                    <key>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\OpenSSL Light (64-bit)_is1</key>
                    <logic>exists</logic>
                    <name>DisplayName</name>
                </registryTest>
            </ruleList>
        </setInstallerVariable>
    </initializationActionList>
    <componentList>
        <component>
            <name>default</name>
            <description>Default Component</description>
            <canBeEdited>1</canBeEdited>
            <selected>1</selected>
            <show>1</show>
            <folderList>
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}</destination>
                    <name>programfiles</name>
                    <platforms>all</platforms>
                    <shortcutList>
                        <shortcut>
                            <comment>Uninstall</comment>
                            <exec>${installdir}/${uninstallerName}</exec>
                            <icon>${installdir}/bitcredit.png</icon>
                            <name>Uninstall ${product_fullname}</name>
                            <path>${installdir}</path>
                            <platforms>all</platforms>
                            <runAsAdmin>0</runAsAdmin>
                            <runInTerminal>0</runInTerminal>
                            <windowsExec>${installdir}/${uninstallerName}.exe</windowsExec>
                            <windowsPath>${installdir}</windowsPath>
                        </shortcut>
                    </shortcutList>
                    <distributionFileList>
                        <distributionFile>
                            <origin>${build_project_directory}/images/bitcredit.png</origin>
                        </distributionFile>
                    </distributionFileList>
                </folder>
                <folder>
                    <destination>${installdir}/frontend</destination>
                    <name>frontend</name>
                    <platforms>all</platforms>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>${fesourcedir}/*</origin>
                            <allowWildcards>1</allowWildcards>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
                <folder>
                    <destination>${installdir}</destination>
                    <name>windows_only_files</name>
                    <platforms>windows-x64</platforms>
                    <distributionFileList>
                        <distributionFile>
                            <origin>${besourcedir}/bitcredit.exe</origin>
                        </distributionFile>
                        <distributionDirectory>
                            <origin>${build_project_directory}/windows/*</origin>
                            <allowWildcards>1</allowWildcards>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
                <folder>
                    <destination>${installdir}</destination>
                    <name>osx_only_files</name>
                    <platforms>osx</platforms>
                    <distributionFileList>
                        <distributionFile>
                            <origin>${besourcedir}/bitcredit</origin>
                        </distributionFile>
                        <distributionDirectory>
                            <origin>${build_project_directory}/macos/*</origin>
                            <allowWildcards>1</allowWildcards>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
            </folderList>
            <startMenuShortcutList>
                <startMenuShortcut>
                    <comment>Uninstall ${product_fullname}</comment>
                    <name>Uninstall ${product_fullname}</name>
                    <runAsAdmin>0</runAsAdmin>
                    <runInTerminal>0</runInTerminal>
                    <windowsExec>${installdir}/${uninstallerName}.exe</windowsExec>
                    <windowsExecArgs></windowsExecArgs>
                    <windowsIcon></windowsIcon>
                    <windowsPath>${installdir}/</windowsPath>
                </startMenuShortcut>
            </startMenuShortcutList>
            <desktopShortcutList>
                <shortcut>
                    <name>${product_fullname}</name>
                    <runInTerminal>0</runInTerminal>
                    <windowsExec>http://localhost:${http_port}</windowsExec>
                    <windowsIcon>${installdir}/bitcredit.ico</windowsIcon>
                </shortcut>
            </desktopShortcutList>
        </component>
    </componentList>
    <preInstallationActionList>
        <getFreePort>
            <finalPort>9000</finalPort>
            <initialPort>8000</initialPort>
            <variable>http_port</variable>
        </getFreePort>
        <setInstallerVariable>
            <name>be_service_name</name>
            <persist>1</persist>
            <value>org.bitcr.core.service</value>
        </setInstallerVariable>
        <setInstallerVariable>
            <name>osx_service_name</name>
            <persist>1</persist>
            <value>org.bitcr.core.service</value>
        </setInstallerVariable>
    </preInstallationActionList>
    <postInstallationActionList>
        <findFile>
            <baseDirectory>${installdir}/frontend/assets</baseDirectory>
            <pattern>index-*.js</pattern>
            <variable>fe_index_file_path</variable>
            <progressText>Configuring Frontend</progressText>
        </findFile>
        <substitute>
            <files>${fe_index_file_path}</files>
            <type>exact</type>
            <substitutionList>
                <substitution pattern="%BITCR_BE_URL%" value="http://localhost:${http_port}/api" />
            </substitutionList>
            <progressText>Configuring Frontend</progressText>
        </substitute>
        <createDirectory path="${installdir}/logs"/>
        <if>
            <actionList>
                <runProgram>
                    <runAs>Administrator</runAs>
                    <program>${installdir}/VC_redist.x64.v14_42.exe</program>
                    <programArguments>/quiet /norestart</programArguments>
                    <ruleList>
                        <isFalse value="${skip_vc_install}"/>
                    </ruleList>
                    <progressText>Installing Visual C++ Redistributable</progressText>
                </runProgram>
                <runProgram>
                    <runAs>Administrator</runAs>
                    <program>${installdir}/Win64OpenSSL_Light-3_4_0.exe</program>
                    <programArguments>/SP /VERYSILENT /NORESTART</programArguments>
                    <ruleList>
                        <isFalse value="${skip_openssl_install}"/>
                    </ruleList>
                    <progressText>Installing OpenSSL</progressText>
                </runProgram>
                <runProgram>
                    <runAs>Administrator</runAs>
                    <program>${installdir}/nssm.exe</program>
                    <programArguments>install "${be_service_name}" "${installdir}\bitcredit.exe" "--http-port ${http_port} --p2p-port 0 --surreal-db-connection rocksdb://data/surreal --nostr-relay wss://bitcr-cloud-run-03-550030097098.europe-west1.run.app --bitcoin-network mainnet"</programArguments>
                    <workingDirectory>${installdir}</workingDirectory>
                    <progressText>Installing Bitcredit Client Service</progressText>
                </runProgram>
                <runProgram>
                    <runAs>Administrator</runAs>
                    <program>${installdir}/nssm.exe</program>
                    <programArguments>set "${be_service_name}" DisplayName "Bitcredit Core"</programArguments>
                    <workingDirectory>${installdir}</workingDirectory>
                    <progressText>Installing Bitcredit Client Service</progressText>
                </runProgram>
                <runProgram>
                    <runAs>Administrator</runAs>
                    <program>${installdir}/nssm.exe</program>
                    <programArguments>set "${be_service_name}" AppStdout "${installdir}\logs\stdout.txt"</programArguments>
                    <workingDirectory>${installdir}</workingDirectory>
                    <progressText>Installing Bitcredit Client Service</progressText>
                </runProgram>
                <runProgram>
                    <runAs>Administrator</runAs>
                    <program>${installdir}/nssm.exe</program>
                    <programArguments>set "${be_service_name}" AppStderr "${installdir}\logs\stderr.txt"</programArguments>
                    <workingDirectory>${installdir}</workingDirectory>
                    <progressText>Installing Bitcredit Client Service</progressText>
                </runProgram>
                <runProgram>
                    <runAs>Administrator</runAs>
                    <program>${installdir}/nssm.exe</program>
                    <programArguments>set "${be_service_name}" AppRestartDelay 300000</programArguments>
                    <workingDirectory>${installdir}</workingDirectory>
                    <progressText>Installing Bitcredit Client Service</progressText>
                </runProgram>
                <runProgram>
                    <runAs>Administrator</runAs>
                    <program>${installdir}/nssm.exe</program>
                    <programArguments>start "${be_service_name}" "SERVICE_AUTO_START"</programArguments>
                    <workingDirectory>${installdir}</workingDirectory>
                    <progressText>Starting Bitcredit Client Service</progressText>
                </runProgram>
            </actionList>
            <conditionRuleList>
                <platformTest type="windows-x64"/>
            </conditionRuleList>
        </if>
        <if>
            <actionList>
                <runProgram>
                    <program>chmod</program>
                    <programArguments>+x install.sh</programArguments>
                    <workingDirectory>${installdir}</workingDirectory>
                    <progressText>Adjusting permissions</progressText>
                </runProgram>
                <runProgram>
                    <program>chmod</program>
                    <programArguments>+x askpass.sh</programArguments>
                    <workingDirectory>${installdir}</workingDirectory>
                    <progressText>Adjusting permissions</progressText>
                </runProgram>
                <runProgram>
                    <program>./install.sh</program>
                    <workingDirectory>${installdir}</workingDirectory>
                    <progressText>Installing dependencies</progressText>
                </runProgram>
                <runProgram>
                    <program>chmod</program>
                    <programArguments>+x bitcredit</programArguments>
                    <workingDirectory>${installdir}</workingDirectory>
                    <progressText>Adjusting permissions</progressText>
                </runProgram>
                <writeFile>
                    <path>${installdir}/${osx_service_name}.plist</path>
                    <encoding>utf-8</encoding>
                    <text><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
                <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
                <plist version="1.0">
                <dict>
                    <key>Label</key>
                    <string>${osx_service_name}</string>
                    <key>ProgramArguments</key>
                    <array>
                        <string>${installdir}/bitcredit</string>
                        <string>--http-port</string>
                        <string>${http_port}</string>
                        <string>--p2p-port</string>
                        <string>0</string>
                        <string>--surreal-db-connection</string>
                        <string>rocksdb://data/surreal</string>
                        <string>--nostr-relay</string>
                        <string>wss://bitcr-cloud-run-03-550030097098.europe-west1.run.app</string>
                        <string>--bitcoin-network</string>
                        <string>mainnet</string>
                    </array>
                    <key>WorkingDirectory</key>
                    <string>${installdir}</string>
                    <key>KeepAlive</key>
                    <true/>
                    <key>RunAtLoad</key>
                    <true/>
                    <key>StandardOutPath</key>
                    <string>${installdir}/logs/service.log</string>
                    <key>StandardErrorPath</key>
                    <string>${installdir}/logs/service.err</string>
                </dict>
                </plist>
                ]]></text>
                    <progressText>Creating Bitcredit Client Service specification</progressText>
                </writeFile>
                <copyFile>
                    <origin>${installdir}/${osx_service_name}.plist</origin>
                    <destination>~/Library/LaunchAgents/${osx_service_name}.plist</destination>
                    <progressText>Creating Bitcredit Client Service specification</progressText>
                </copyFile>
                <runProgram>
                    <program>chmod</program>
                    <programArguments>+x ~/Library/LaunchAgents/${osx_service_name}.plist</programArguments>
                    <progressText>Adjusting permissions</progressText>
                </runProgram>
                <runProgram>
                    <program>launchctl</program>
                    <programArguments>bootstrap gui/$(id -u) ~/Library/LaunchAgents/${osx_service_name}.plist</programArguments>
                    <progressText>Bootstrapping Bitcredit Client Service</progressText>
                </runProgram>
                <runProgram>
                    <program>cp</program>
                    <programArguments>'./BitCredit Core.webloc' ~/Desktop/</programArguments>
                    <workingDirectory>${installdir}</workingDirectory>
                    <progressText>Creating Shortcut on the Desktop</progressText>
                </runProgram>
            </actionList>
            <conditionRuleList>
                <platformTest type="osx"/>
            </conditionRuleList>
        </if>
    </postInstallationActionList>
    <preUninstallationActionList>
        <deleteWindowsService>
            <displayName></displayName>
            <serviceName>${be_service_name}</serviceName>
            <ruleList>
                <windowsServiceTest service="${be_service_name}" condition="exists"/>
            </ruleList>
        </deleteWindowsService>
        <if>
            <actionList>
                <runProgram>
                    <program>launchctl</program>
                    <programArguments>bootout gui/$(id -u) ~/Library/LaunchAgents/${osx_service_name}.plist</programArguments>
                    <progressText>Bootout Bitcredit Client Service</progressText>
                </runProgram>
                <deleteFile path="~/Library/LaunchAgents/${osx_service_name}.plist"/>
                <deleteFile path="${installdir}/${osx_service_name}.plist"/>
                <deleteFile path="~/Desktop/BitCredit Core.webloc"/>
            </actionList>
            <conditionRuleList>
                <platformTest type="osx"/>
            </conditionRuleList>
        </if>
        <deleteFile path="${installdir}/files"/>
        <deleteFile path="${installdir}/quotes"/>
        <deleteFile path="${installdir}/logs"/>
        <showQuestion text="Do you want the uninstallation to also remove the database data?" variable="remove_data" />
        <deleteFile>
            <path>${installdir}/data</path>
            <ruleList>
                <compareText text="${remove_data}" value="yes" logic="equals" />
            </ruleList>
        </deleteFile>
    </preUninstallationActionList>
    <enableRollback>1</enableRollback>
    <enableTimestamp>1</enableTimestamp>
    <vendor></vendor>
    <outputDirectory>.</outputDirectory>
    <parameterList>
        <directoryParameter>
            <name>installdir</name>
            <description>Installer.Parameter.installdir.description</description>
            <explanation>Installer.Parameter.installdir.explanation</explanation>
            <value></value>
            <default>${platform_install_prefix}/${product_shortname}-${product_version}</default>
            <allowEmptyValue>0</allowEmptyValue>
            <ask>yes</ask>
            <cliOptionName>prefix</cliOptionName>
            <mustBeWritable>yes</mustBeWritable>
            <mustExist>0</mustExist>
            <width>40</width>
        </directoryParameter>
    </parameterList>
</project>
